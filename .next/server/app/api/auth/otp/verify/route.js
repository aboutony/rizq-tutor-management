"use strict";(()=>{var e={};e.id=870,e.ids=[870],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},2254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},7261:e=>{e.exports=require("node:util")},5711:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>N,requestAsyncStorage:()=>R,routeModule:()=>E,serverHooks:()=>S,staticGenerationAsyncStorage:()=>A});var a={};r.r(a),r.d(a,{POST:()=>P});var s=r(9303),o=r(8716),i=r(670),n=r(7070),d=r(9487),p=r(2635),c=r(7682),l=r(5689),u=r(5547),h=r(1079),y=r(7219),_=r(1884);class f{_payload;_protectedHeader;_unprotectedHeader;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){let r;if(!this._protectedHeader&&!this._unprotectedHeader)throw new u.GW("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!(0,l.Z)(this._protectedHeader,this._unprotectedHeader))throw new u.GW("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let a={...this._protectedHeader,...this._unprotectedHeader},s=(0,_.Z)(u.GW,new Map([["b64",!0]]),t?.crit,this._protectedHeader,a),o=!0;if(s.has("b64")&&"boolean"!=typeof(o=this._protectedHeader.b64))throw new u.GW('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:i}=a;if("string"!=typeof i||!i)throw new u.GW('JWS "alg" (Algorithm) Header Parameter missing or invalid');(0,y.Y)(i,e,"sign");let n=this._payload;o&&(n=h.g7.encode((0,p.cv)(n))),r=this._protectedHeader?h.g7.encode((0,p.cv)(JSON.stringify(this._protectedHeader))):h.g7.encode("");let d=(0,h.zo)(r,h.g7.encode("."),n),f=await (0,c.Z)(i,e,d),g={signature:(0,p.cv)(f),payload:""};return o&&(g.payload=h.xv.decode(n)),this._unprotectedHeader&&(g.header=this._unprotectedHeader),this._protectedHeader&&(g.protected=h.xv.decode(r)),g}}class g{_flattened;constructor(e){this._flattened=new f(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){let r=await this._flattened.sign(e,t);if(void 0===r.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}var m=r(2741),H=r(5165),x=r(1301);function w(e,t){if(!Number.isFinite(t))throw TypeError(`Invalid ${e} input`);return t}class T{_payload;constructor(e={}){if(!(0,H.Z)(e))throw TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:w("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:w("setNotBefore",(0,m.Z)(e))}:this._payload={...this._payload,nbf:(0,m.Z)(new Date)+(0,x.Z)(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:w("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:w("setExpirationTime",(0,m.Z)(e))}:this._payload={...this._payload,exp:(0,m.Z)(new Date)+(0,x.Z)(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:(0,m.Z)(new Date)}:e instanceof Date?this._payload={...this._payload,iat:w("setIssuedAt",(0,m.Z)(e))}:"string"==typeof e?this._payload={...this._payload,iat:w("setIssuedAt",(0,m.Z)(new Date)+(0,x.Z)(e))}:this._payload={...this._payload,iat:w("setIssuedAt",e)},this}}class b extends T{_protectedHeader;setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){let r=new g(h.g7.encode(JSON.stringify(this._payload)));if(r.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new u.uv("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}var v=r(1615);async function P(e){try{let{phone:t,code:r,role:a,locale:s}=await e.json();if(!t||!r)return n.NextResponse.json({message:"Phone and code are required"},{status:400});if("123456"!==r)return n.NextResponse.json({message:"Invalid OTP"},{status:401});let o="STUDENT_PARENT"===a?"STUDENT_PARENT":"TUTOR",i=s||"en",p=await d.Z.connect();try{let e;if("TUTOR"===o){let r=await p.query("SELECT id FROM tutors WHERE phone = $1",[t]);if(0===r.rows.length)return n.NextResponse.json({message:"User not found"},{status:404});e=r.rows[0].id}else e=`student_${t.replace(/\D/g,"").slice(-8)}`;let r=new TextEncoder().encode(process.env.JWT_SECRET||"default-secret-key-for-dev"),a=await new b({userId:e,tutorId:"TUTOR"===o?e:void 0,role:o,locale:i}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").setIssuedAt().sign(r);return(0,v.cookies)().set("rizq_session",a,{httpOnly:!0,secure:!0,sameSite:"strict",path:"/",maxAge:86400}),(0,v.cookies)().set("NEXT_LOCALE",i,{httpOnly:!1,secure:!0,sameSite:"strict",path:"/",maxAge:31536e3}),n.NextResponse.json({message:"Login successful",role:o,locale:i},{status:200})}finally{p.release()}}catch(e){return console.error("OTP Verify Error:",e),n.NextResponse.json({message:"Internal Server Error"},{status:500})}}let E=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/otp/verify/route",pathname:"/api/auth/otp/verify",filename:"route",bundlePath:"app/api/auth/otp/verify/route"},resolvedPagePath:"E:\\AFKARI\\New Ideas\\RIZQ APP\\rizq-tutor-management\\app\\api\\auth\\otp\\verify\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:A,serverHooks:S}=E,j="/api/auth/otp/verify/route";function N(){return(0,i.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:A})}},9487:(e,t,r)=>{r.d(t,{Z:()=>a});let a=new(r(5900)).Pool({connectionString:process.env.POSTGRES_URL})},8238:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let a=Reflect.get(e,t,r);return"function"==typeof a?a.bind(e):a}static set(e,t,r,a){return Reflect.set(e,t,r,a)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,615,972,883],()=>r(5711));module.exports=a})();