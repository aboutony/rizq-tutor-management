"use strict";(()=>{var e={};e.id=951,e.ids=[951],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},6113:e=>{e.exports=require("crypto")},2254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},7261:e=>{e.exports=require("node:util")},3975:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>m,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{POST:()=>f});var o=r(9303),n=r(8716),s=r(670),i=r(7070),c=r(9487),l=r(446),d=r(6522),u=r(6543);let p=u.Ryn({action:u.KmV(["accept","reject"])});async function f(e,{params:t}){let r;let a=await (0,l._)();if(!a)return i.NextResponse.json({message:"Unauthorized"},{status:401});let{lessonId:o}=t;if(!o)return i.NextResponse.json({message:"Lesson ID is required"},{status:400});try{r=await e.json();let t=p.safeParse(r);if(!t.success)return i.NextResponse.json({message:"Invalid action"},{status:400});let{action:n}=t.data,s=await c.Z.connect();try{let e=await s.query("SELECT requested_start_at_utc FROM lessons WHERE id = $1 AND tutor_id = $2 AND status = 'requested'",[o,a]);if(0===e.rows.length)return i.NextResponse.json({message:"Lesson not found or action not allowed"},{status:404});await s.query("BEGIN");let t=e.rows[0].requested_start_at_utc;if("accept"===n){await s.query("UPDATE lessons SET status = 'confirmed', confirmed_start_at_utc = $1 WHERE id = $2",[t,o]);let e=(0,d.l)(),r=(0,d.l)();await s.query("INSERT INTO link_tokens (lesson_id, token_hash, purpose, expires_at) VALUES ($1, $2, 'cancel', $3), ($1, $4, 'reschedule', $3)",[o,e.hash,t,r.hash]);let a=process.env.NEXT_PUBLIC_BASE_URL||"http://localhost:3000";console.log("--- ACTION LINKS (FOR PARENT) ---"),console.log(`Cancel Link: ${a}/l/${o}/cancel/${e.token}`),console.log(`Reschedule Link: ${a}/l/${o}/reschedule/${r.token}`),console.log("------------------------------------")}else"reject"===n&&(await s.query("UPDATE lessons SET status = 'canceled' WHERE id = $1",[o]),await s.query("INSERT INTO lesson_cancellations (lesson_id, canceled_by, is_late) VALUES ($1, 'tutor', false)",[o]));return await s.query("COMMIT"),i.NextResponse.json({message:`Lesson ${n}ed successfully.`},{status:200})}catch(e){throw await s.query("ROLLBACK"),e}finally{s.release()}}catch(e){return console.error("Failed to process lesson action:",e),i.NextResponse.json({message:"Internal Server Error"},{status:500})}}let y=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/tutor/requests/[lessonId]/route",pathname:"/api/tutor/requests/[lessonId]",filename:"route",bundlePath:"app/api/tutor/requests/[lessonId]/route"},resolvedPagePath:"E:\\AFKARI\\New Ideas\\RIZQ APP\\rizq-tutor-management\\app\\api\\tutor\\requests\\[lessonId]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:m}=y,g="/api/tutor/requests/[lessonId]/route";function v(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:w})}},9487:(e,t,r)=>{r.d(t,{Z:()=>a});let a=new(r(5900)).Pool({connectionString:process.env.POSTGRES_URL})},446:(e,t,r)=>{r.d(t,{_:()=>s,c:()=>n});var a=r(1615),o=r(6176);async function n(){let e=(0,a.cookies)(),t=e.get("rizq_session")?.value;if(!t)return null;try{let e=new TextEncoder().encode(process.env.JWT_SECRET||"default-secret-key-for-dev"),{payload:r}=await o._(t,e),a=r.userId||r.tutorId||null,n=r.role||"TUTOR",s=r.locale||"en";if(!a)return null;return{userId:a,role:n,locale:s}}catch(e){return console.error("JWT Verification Error:",e),null}}async function s(){let e=await n();return e&&"TUTOR"===e.role?e.userId:null}},6522:(e,t,r)=>{r.d(t,{l:()=>o,q:()=>n});var a=r(6113);function o(){let e=(0,a.randomBytes)(32).toString("hex"),t=(0,a.createHash)("sha256").update(e).digest("hex");return{token:e,hash:t}}function n(e){return(0,a.createHash)("sha256").update(e).digest("hex")}},8238:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let a=Reflect.get(e,t,r);return"function"==typeof a?a.bind(e):a}static set(e,t,r,a){return Reflect.set(e,t,r,a)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},6176:(e,t,r)=>{r.d(t,{_:()=>R});var a=r(2635),o=r(6005),n=r(7261),s=r(6042),i=r(2690),c=r(7682),l=r(3194);let d=(0,n.promisify)(o.verify),u=async(e,t,r,a)=>{let n=(0,l.Z)(e,t,"verify");if(e.startsWith("HS")){let t=await (0,c.Z)(e,n,a);try{return o.timingSafeEqual(r,t)}catch{return!1}}let u=(0,s.Z)(e),p=(0,i.Z)(e,n);try{return await d(u,a,p,r)}catch{return!1}};var p=r(5547),f=r(1079),y=r(5689),h=r(5165),w=r(7219),m=r(1884);let g=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var v=r(7735);let b=e=>e.d?(0,o.createPrivateKey)({format:"jwk",key:e}):(0,o.createPublicKey)({format:"jwk",key:e});async function S(e,t){if(!(0,h.Z)(e))throw TypeError("JWK must be an object");switch(t||=e.alg,e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw TypeError('missing "k" (Key Value) Parameter value');return(0,a.Jx)(e.k);case"RSA":if("oth"in e&&void 0!==e.oth)throw new p.jq('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return b({...e,alg:t});default:throw new p.jq('Unsupported "kty" (Key Type) Parameter value')}}async function x(e,t,r){let o,n;if(!(0,h.Z)(e))throw new p.GW("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new p.GW('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new p.GW("JWS Protected Header incorrect type");if(void 0===e.payload)throw new p.GW("JWS Payload missing");if("string"!=typeof e.signature)throw new p.GW("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,h.Z)(e.header))throw new p.GW("JWS Unprotected Header incorrect type");let s={};if(e.protected)try{let t=(0,a.Jx)(e.protected);s=JSON.parse(f.xv.decode(t))}catch{throw new p.GW("JWS Protected Header is invalid")}if(!(0,y.Z)(s,e.header))throw new p.GW("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let i={...s,...e.header},c=(0,m.Z)(p.GW,new Map([["b64",!0]]),r?.crit,s,i),l=!0;if(c.has("b64")&&"boolean"!=typeof(l=s.b64))throw new p.GW('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:d}=i;if("string"!=typeof d||!d)throw new p.GW('JWS "alg" (Algorithm) Header Parameter missing or invalid');let b=r&&g("algorithms",r.algorithms);if(b&&!b.has(d))throw new p.FP('"alg" (Algorithm) Header Parameter value not allowed');if(l){if("string"!=typeof e.payload)throw new p.GW("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new p.GW("JWS Payload must be a string or an Uint8Array instance");let x=!1;"function"==typeof t?(t=await t(s,e),x=!0,(0,w.Y)(d,t,"verify"),(0,v.x)(t)&&(t=await S(t,d))):(0,w.Y)(d,t,"verify");let k=(0,f.zo)(f.g7.encode(e.protected??""),f.g7.encode("."),"string"==typeof e.payload?f.g7.encode(e.payload):e.payload);try{o=(0,a.Jx)(e.signature)}catch{throw new p.GW("Failed to base64url decode the signature")}if(!await u(d,t,o,k))throw new p.nx;if(l)try{n=(0,a.Jx)(e.payload)}catch{throw new p.GW("Failed to base64url decode the payload")}else n="string"==typeof e.payload?f.g7.encode(e.payload):e.payload;let W={payload:n};return(void 0!==e.protected&&(W.protectedHeader=s),void 0!==e.header&&(W.unprotectedHeader=e.header),x)?{...W,key:t}:W}async function k(e,t,r){if(e instanceof Uint8Array&&(e=f.xv.decode(e)),"string"!=typeof e)throw new p.GW("Compact JWS must be a string or Uint8Array");let{0:a,1:o,2:n,length:s}=e.split(".");if(3!==s)throw new p.GW("Invalid Compact JWS");let i=await x({payload:o,protected:a,signature:n},t,r),c={payload:i.payload,protectedHeader:i.protectedHeader};return"function"==typeof t?{...c,key:i.key}:c}var W=r(2741),T=r(1301);let _=e=>e.toLowerCase().replace(/^application\//,""),P=(e,t)=>"string"==typeof e?t.includes(e):!!Array.isArray(e)&&t.some(Set.prototype.has.bind(new Set(e))),q=(e,t,r={})=>{let a,o;try{a=JSON.parse(f.xv.decode(t))}catch{}if(!(0,h.Z)(a))throw new p.uv("JWT Claims Set must be a top-level JSON object");let{typ:n}=r;if(n&&("string"!=typeof e.typ||_(e.typ)!==_(n)))throw new p.YS('unexpected "typ" JWT header value',a,"typ","check_failed");let{requiredClaims:s=[],issuer:i,subject:c,audience:l,maxTokenAge:d}=r,u=[...s];for(let e of(void 0!==d&&u.push("iat"),void 0!==l&&u.push("aud"),void 0!==c&&u.push("sub"),void 0!==i&&u.push("iss"),new Set(u.reverse())))if(!(e in a))throw new p.YS(`missing required "${e}" claim`,a,e,"missing");if(i&&!(Array.isArray(i)?i:[i]).includes(a.iss))throw new p.YS('unexpected "iss" claim value',a,"iss","check_failed");if(c&&a.sub!==c)throw new p.YS('unexpected "sub" claim value',a,"sub","check_failed");if(l&&!P(a.aud,"string"==typeof l?[l]:l))throw new p.YS('unexpected "aud" claim value',a,"aud","check_failed");switch(typeof r.clockTolerance){case"string":o=(0,T.Z)(r.clockTolerance);break;case"number":o=r.clockTolerance;break;case"undefined":o=0;break;default:throw TypeError("Invalid clockTolerance option type")}let{currentDate:y}=r,w=(0,W.Z)(y||new Date);if((void 0!==a.iat||d)&&"number"!=typeof a.iat)throw new p.YS('"iat" claim must be a number',a,"iat","invalid");if(void 0!==a.nbf){if("number"!=typeof a.nbf)throw new p.YS('"nbf" claim must be a number',a,"nbf","invalid");if(a.nbf>w+o)throw new p.YS('"nbf" claim timestamp check failed',a,"nbf","check_failed")}if(void 0!==a.exp){if("number"!=typeof a.exp)throw new p.YS('"exp" claim must be a number',a,"exp","invalid");if(a.exp<=w-o)throw new p.fy('"exp" claim timestamp check failed',a,"exp","check_failed")}if(d){let e=w-a.iat;if(e-o>("number"==typeof d?d:(0,T.Z)(d)))throw new p.fy('"iat" claim timestamp check failed (too far in the past)',a,"iat","check_failed");if(e<0-o)throw new p.YS('"iat" claim timestamp check failed (it should be in the past)',a,"iat","check_failed")}return a};async function R(e,t,r){let a=await k(e,t,r);if(a.protectedHeader.crit?.includes("b64")&&!1===a.protectedHeader.b64)throw new p.uv("JWTs MUST NOT use unencoded payload");let o={payload:q(a.protectedHeader,a.payload,r),protectedHeader:a.protectedHeader};return"function"==typeof t?{...o,key:a.key}:o}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,615,972,883,543],()=>r(3975));module.exports=a})();